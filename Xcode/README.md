# Xcode Recipes

This folder contains fully functioning Xcode download, extraction, and Munki 
recipes.

## Use Overrides to download

To download Xcode, you need to create an override with the following two input 
variables:
* APPLE_ID: an AppleID that has access to the developer downloads portal
* PASSWORD: the password to the AppleID

This override can be used for the .download alone, or with the .munki recipes.

*WARNING! Your password will appear in plain text in the AutoPkg verbose logs. 
If you use more than one -v, this password will not be secret.*

## A note about version numbers

These recipes extract the major, minor, and patch versions from the version 
numbers, as well as what Apple refers to as the "bundle" version, as well as 
the build number. This is because Apple has, at various times, bumped a beta of 
Xcode into GM version by only increasing the build number one digit, and yet 
somehow still introduced functional changes. 

Because of the fact that any possible release of Xcode could behave differently 
than identically-numbered previous releases, we use all possible version data 
to differentiate Xcode releases.

THe build number is used in the Display Name only, and not included in the 
version information used by Munki to determine install status.

## Recipes

### Xcode.munki Recipe

This is the "classic" Xcode Munki recipe. It will import an item into Munki 
simply named "Xcode", and installs into "/Applications/Xcode.app", similar to 
how the App Store version behaves.

Example output:
```
The following new items were imported into Munki:
    Name   Version           Catalogs  Pkginfo Path                                   Pkg Repo Path
    ----   -------           --------  ------------                                   -------------
    Xcode  10.2.1.14490.122  testing   apps/apple/xcode/Xcode-10.2.1.14490.122.plist  apps/apple/xcode/Xcode-10.2.1.14490.122.dmg
```

### XcodeVersionedName.munki Recipe

If you want to be able to install multiple versions of Xcode side-by-side, or 
otherwise want to differentiate each version of Xcode, we can't name each 
version "Xcode". Instead, each version of Xcode is individually named.

This Munki recipe imports an item named "XcodeMajorMinorPatch", where the 
numbers are inserted accordingly: "Xcode10.2.1".

Unlike the regular Xcode.munki recipe, this recipe also renames the .app on 
disk. The app that is installed on disk is named similarly, 
"/Applications/Xcode_10.2.1.app". The disk image that the recipe produces is 
named similarly as well, although the DMG name is ignored by Munki as it 
renames it accordingly.

### XcodeCLITools.download

This download recipe shows how you can easily create new recipes, or even 
overrides, that change what files to look for in the list of URLs from the 
download portal.

This recipe will download the Command Line Tools for a given version of macOS, 
which is specified as the `MACOS_VERSION` input variable. You could swap this 
out for previous versions of macOS, although please bear in mind that Apple 
has a tendency to change naming conventions randomly with new versions, so the 
existing regex pattern might break at any time.

## How It Works

### Getting the cookies
There are three custom processors that are used to get the right download data. 
First, the AppleDataGatherer simply takes the AppleID & password data and writes
it out to a file, which is passed to curl. This is done to avoid having the
password show up in the process list.

The AppleCookieDownloader makes two separate curl calls. The first one sends the
login data generated by AppleDataGatherer to generate the "myacinfo" cookie
stored in "login_cookies". The second one uses the login_cookie to get access
to the download list, which generates the "download_cookies".

With the necessary cookies created, we can now access the downloads list. This 
list is actually a json blob inside a gz archive, so we must use `gunzip` to 
extract it, and then serialize it into JSON data. If the access creds fail, this 
will be how we tell - the downloads list will actually be raw JSON indicating an 
error response from the server, rather than JSON wrapped in gzip.

### Parsing the list of downloads
The file is stored inside the AutoPkg cache, in 
`%RECIPE_CACHE_DIR%/downloads/listDownloads`. You can read this file yourself if
 you wish to see a full list of all information available for download.

We use regex to parse the list of download URLs for the given pattern we want. 
The result will be a single download URL that can be passed to URLDownloader,
which also uses the download cookie to access the data.

### Xip extraction

Hat tip to Graham Gilbert for pointing out that `xip --extract` does a great job
at extracting xips without all the hard work of using xar, cpio, or pbzx 
madness.

## Important Notes

Xcode is a nasty beast. Apple has no compunction against changing it any time of
time or night, or renaming it, or breaking assumptions. Since they provide no 
useful API of any kind to automate this, we have to use hacky workarounds like 
this to do something straightforward like downloading software.

Be warned that it could break at any moment.

Also, Xcode is a roughly ~5 GB download, so depending on your internet, the 
download portion alone could take significant time. Then, extracting the xip 
into the app takes at least 10-15 minutes on an SSD drive. Then we need to 
wrap the app in a disk image, which takes another 10-15 minutes depending on 
your machine.
